# Introduction to CPU profiling

CPU profiling is not the only profiling possible, but it is the most important. [Linux profiling with performance counters](https://perfwiki.github.io/main/) explains how performance measurement can be done. It is done using `perf` command. To collect the profiles on per-process, per-thread, per-cpu basis. We need an illustrative program to do some measurements. [bottlencks.cpp](bottlenecks.cpp) is a simple program generated by [ChatGPT](https://chatgpt.com/) for this purpose. To compile the program

```
g++ -O2 -g -ggdb -fno-inline -std=c++17 bottlenecks.cpp -o bottlenecks
```

Now you can run it under `perf`

```sh
$ /usr/lib/linux-tools-6.8.0-85/perf record -g -F 99 -- ./bottlencks

Starting CPU-bound section...
Primes computed: 2262
Starting memory-bound section...
Matrix multiplication done for size 300x300
Starting I/O-bound section...
File written with 1000000 lines.
Total time: 0.170326 s
[ perf record: Woken up 1 times to write data ]
[ perf record: Captured and wrote 0.024 MB perf.data (18 samples) ]
```

This produces a file `perf.data` in the current directory as shown above. There are multiple ways to analyze the output. Simples is

```sh
$ /usr/lib/linux-tools-6.8.0-85/perf report -g --stdio

# To display the perf.data header info, please use --header/--header-only options.
#
#
# Total Lost Samples: 0
#
# Samples: 18  of event 'cycles:P'
# Event count (approx.): 749271655
#
# Children      Self  Command      Shared Object         Symbol                                                                                                                                 >
# ........  ........  ...........  ....................  .......................................................................................................................................>
#
    66.45%    20.32%  bottlenecks  bottlenecks           [.] random_matrix_multiply(int)
            |
            |--46.13%--random_matrix_multiply(int)
            |
             --20.32%--0
                       random_matrix_multiply(int)

    66.45%     0.00%  bottlenecks  [unknown]             [.] 0000000000000000
            |
            ---0
               random_matrix_multiply(int)

    46.13%    46.13%  bottlenecks  bottlenecks           [.] std::vector<std::vector<double, std::allocator<double> >, std::allocator<std::vector<double, std::allocator<double> > > >::operator>
            |
            ---0
               random_matrix_multiply(int)

    33.43%     0.00%  bottlenecks  bottlenecks           [.] write_file(long)
            |
            ---write_file(long)
...
```

## Flamegraphs with perf

This is how I use it in my work day in and day out. [Brendan Gregg](https://www.brendangregg.com/index.html) created this magical tool that helps us visualize profiling results. He as also documented [Linux performance observability](https://www.brendangregg.com/linuxperf.html) extensively. It posprocesses `perf.data` to produce a `SVG` (Scalable Vector Graphics) file that can be loaded in web-browser enabling us to search/dissect it interactively. He has published his work [here](https://github.com/brendangregg/FlameGraph). Here is how we can use it. First download the scripts from Brendan's github repo.

```sh
wget https://raw.githubusercontent.com/brendangregg/FlameGraph/refs/heads/master/stackcollapse-perf.pl
wget https://raw.githubusercontent.com/brendangregg/FlameGraph/refs/heads/master/flamegraph.pl
```

Once you have these two scripts, we can run in on our `perf.data` file.

```sh
/usr/lib/linux-tools-6.8.0-85/perf script > bottlenecks.perf
perl stackcollapse-perf.pl bottlenecks.perf > bottlenecks.folded
perl flamegraph.pl bottlenecks.folded > bottlenecks.svg
```
All this we need to do is point the browser at [bottlenecks.svg](bottlenecks.svg). You can delete `bottlenecks.perf` and `bottlenecks.folded`.

## References

1. [Linux Observability tools](https://www.brendangregg.com/linuxperf.html)
1. [perf: Linux profiling with performance counters](https://perfwiki.github.io/main/)
1. [Flamegraph](https://github.com/brendangregg/FlameGraph)
